// Professional PDF Report Generator for FinancePro
// This module generates comprehensive financial reports with professional formatting

function generateProfessionalPDF(budgetData, userId, userProfile = null) {
    // Check for jsPDF library
    let jsPDF;

    if (window.jspdf && window.jspdf.jsPDF) {
        jsPDF = window.jspdf.jsPDF;
    } else if (window.jsPDF) {
        jsPDF = window.jsPDF;
    } else {
        throw new Error('jsPDF library not loaded');
    }

    const doc = new jsPDF();

    // Set default font to Times New Roman
    doc.setFont('times', 'normal');

    // Calculate financial metrics
    const allExpenses = budgetData.expenses || [];
    const manualExpenses = allExpenses.filter(expense =>
        !expense.name.includes(' Budget') &&
        !(expense.category === 'Savings' && expense.name.includes('Allocation'))
    );
    const totalExpenses = manualExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
    const income = budgetData.income || 0;
    const savingsGoal = budgetData.savingsGoal || 0;
    const totalSavings = budgetData.totalSavings || 0;
    const remainingBudget = income - totalExpenses;
    const expenseRatio = income > 0 ? (totalExpenses / income) * 100 : 0;
    const savingsProgress = savingsGoal > 0 ? Math.min((totalSavings / savingsGoal) * 100, 100) : 0;

    // Group expenses by category
    const categoryTotals = {};
    manualExpenses.forEach(exp => {
        const category = exp.category || 'Other';
        if (!categoryTotals[category]) {
            categoryTotals[category] = { total: 0, count: 0 };
        }
        categoryTotals[category].total += exp.amount;
        categoryTotals[category].count += 1;
    });

    const sortedCategories = Object.entries(categoryTotals)
        .sort((a, b) => b[1].total - a[1].total);

    // Professional color scheme
    const colors = {
        primary: [88, 28, 135],        // Deep purple
        primaryLight: [139, 92, 246],  // Light purple
        secondary: [30, 64, 175],      // Deep blue
        success: [22, 163, 74],        // Green
        warning: [234, 88, 12],        // Orange
        danger: [220, 38, 38],         // Red
        text: [17, 24, 39],            // Almost black
        textLight: [75, 85, 99],       // Gray
        border: [209, 213, 219],       // Light gray
        bgLight: [249, 250, 251]       // Very light gray
    };

    let yPos = 20;
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);

    // Helper function to add page header
    const addPageHeader = (pageNum) => {
        if (pageNum > 1) {
            doc.setFillColor(...colors.primary);
            doc.rect(0, 0, pageWidth, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('times', 'bold');
            doc.text('FinancePro Financial Report', margin, 10);
            doc.setFontSize(8);
            doc.setFont('times', 'normal');
            doc.text(`Page ${pageNum}`, pageWidth - margin, 10, { align: 'right' });
        }
    };

    // Helper function to add page footer
    const addPageFooter = (pageNum) => {
        doc.setDrawColor(...colors.border);
        doc.setLineWidth(0.5);
        doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
        doc.setTextColor(...colors.textLight);
        doc.setFontSize(8);
        doc.setFont('times', 'normal');
        const reportDate = new Date().toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(`Generated by FinancePro | ${reportDate}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
    };

    // ===== PAGE 1: COVER PAGE =====
    // Header banner
    doc.setFillColor(...colors.primary);
    doc.rect(0, 0, pageWidth, 80, 'F');

    // Title
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(32);
    doc.setFont('times', 'bold');
    doc.text('FINANCIAL REPORT', pageWidth / 2, 35, { align: 'center' });

    doc.setFontSize(14);
    doc.setFont('times', 'normal');
    doc.text('Personal Finance Analysis', pageWidth / 2, 50, { align: 'center' });

    const reportDate = new Date().toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    doc.setFontSize(11);
    doc.text(`Report Date: ${reportDate}`, pageWidth / 2, 65, { align: 'center' });

    // User Details Section (if available)
    yPos = 85;
    if (userProfile) {
        doc.setTextColor(...colors.primary);
        doc.setFontSize(14);
        doc.setFont('times', 'bold');
        doc.text('USER DETAILS', margin, yPos);

        yPos += 3;
        doc.setDrawColor(...colors.primary);
        doc.setLineWidth(1);
        doc.line(margin, yPos, margin + 45, yPos);

        yPos += 10;

        const userDetailsData = [];
        if (userProfile.first_name || userProfile.last_name) {
            const fullName = `${userProfile.first_name || ''} ${userProfile.last_name || ''}`.trim();
            if (fullName) userDetailsData.push(['Name', fullName]);
        }
        if (userProfile.email) userDetailsData.push(['Email', userProfile.email]);
        if (userProfile.contact) userDetailsData.push(['Contact', userProfile.contact]);
        if (userProfile.dob) {
            const formattedDob = new Date(userProfile.dob).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            userDetailsData.push(['Date of Birth', formattedDob]);
        }

        if (userDetailsData.length > 0) {
            doc.autoTable({
                startY: yPos,
                body: userDetailsData,
                theme: 'plain',
                styles: { font: 'times' },
                bodyStyles: {
                    fontSize: 10,
                    textColor: colors.text,
                    font: 'times'
                },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { cellWidth: 'auto' }
                },
                margin: { left: margin + 5 }
            });

            yPos = doc.lastAutoTable.finalY + 15;
        }
    } else {
        yPos = 100;
    }

    // Executive Summary Section
    doc.setTextColor(...colors.primary);
    doc.setFontSize(18);
    doc.setFont('times', 'bold');
    doc.text('EXECUTIVE SUMMARY', margin, yPos);

    yPos += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(margin, yPos, margin + 60, yPos);

    yPos += 15;

    // Summary table using autoTable
    const summaryData = [
        ['Total Income', `Rs. ${income.toLocaleString('en-IN')}`],
        ['Total Expenses', `Rs. ${totalExpenses.toLocaleString('en-IN')}`],
        ['Net Balance', `Rs. ${remainingBudget.toLocaleString('en-IN')}`],
        ['Savings Goal', `Rs. ${savingsGoal.toLocaleString('en-IN')}`],
        ['Current Savings', `Rs. ${totalSavings.toLocaleString('en-IN')}`]
    ];

    doc.autoTable({
        startY: yPos,
        head: [['Metric', 'Amount']],
        body: summaryData,
        theme: 'grid',
        styles: { font: 'times' },
        headStyles: {
            fillColor: colors.primary,
            textColor: [255, 255, 255],
            fontSize: 11,
            fontStyle: 'bold',
            halign: 'left',
            font: 'times'
        },
        bodyStyles: {
            fontSize: 10,
            textColor: colors.text,
            font: 'times'
        },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 80 },
            1: { halign: 'right', cellWidth: 'auto' }
        },
        margin: { left: margin, right: margin },
        didParseCell: function (data) {
            // Color code the net balance row
            if (data.row.index === 2 && data.column.index === 1) {
                if (remainingBudget >= 0) {
                    data.cell.styles.textColor = colors.success;
                } else {
                    data.cell.styles.textColor = colors.danger;
                }
                data.cell.styles.fontStyle = 'bold';
            }
        }
    });

    yPos = doc.lastAutoTable.finalY + 20;

    // Key Insights Box
    doc.setFillColor(...colors.bgLight);
    doc.setDrawColor(...colors.border);
    doc.roundedRect(margin, yPos, contentWidth, 40, 3, 3, 'FD');

    yPos += 10;
    doc.setTextColor(...colors.primary);
    doc.setFontSize(12);
    doc.setFont('times', 'bold');
    doc.text('KEY INSIGHTS', margin + 5, yPos);

    yPos += 8;
    doc.setTextColor(...colors.text);
    doc.setFontSize(10);
    doc.setFont('times', 'normal');

    const budgetStatus = remainingBudget >= 0 ? 'Under Budget' : 'Over Budget';
    const statusSymbol = remainingBudget >= 0 ? '\u2713' : '\u2717';
    doc.text(`${statusSymbol} Budget Status: ${budgetStatus}`, margin + 5, yPos);

    yPos += 7;
    doc.text(`Expense Ratio: ${expenseRatio.toFixed(1)}% of income`, margin + 5, yPos);

    yPos += 7;
    doc.text(`Savings Progress: ${savingsProgress.toFixed(1)}% of goal`, margin + 5, yPos);

    // Footer
    addPageFooter(1);

    // ===== PAGE 2: DETAILED ANALYSIS =====
    doc.addPage();
    addPageHeader(2);
    yPos = 30;

    // Income & Expense Analysis
    doc.setTextColor(...colors.primary);
    doc.setFontSize(18);
    doc.setFont('times', 'bold');
    doc.text('INCOME & EXPENSE ANALYSIS', margin, yPos);

    yPos += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(margin, yPos, margin + 80, yPos);

    yPos += 15;

    // Income details table
    doc.setTextColor(...colors.text);
    doc.setFontSize(14);
    doc.setFont('times', 'bold');
    doc.text('Income Overview', margin, yPos);

    yPos += 10;

    const incomeData = [
        ['Monthly Income', `Rs. ${income.toLocaleString('en-IN')}`],
        ['Duration', budgetData.duration || 'Monthly']
    ];

    doc.autoTable({
        startY: yPos,
        body: incomeData,
        theme: 'plain',
        styles: { font: 'times' },
        bodyStyles: {
            fontSize: 10,
            textColor: colors.text,
            font: 'times'
        },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 80 },
            1: { cellWidth: 'auto' }
        },
        margin: { left: margin + 5 }
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Expense details table
    doc.setFontSize(14);
    doc.setFont('times', 'bold');
    doc.text('Expense Overview', margin, yPos);

    yPos += 10;

    const expenseData = [
        ['Total Expenses', `Rs. ${totalExpenses.toLocaleString('en-IN')}`],
        ['Expense Ratio', `${expenseRatio.toFixed(1)}% of income`],
        ['Number of Transactions', manualExpenses.length.toString()]
    ];

    doc.autoTable({
        startY: yPos,
        body: expenseData,
        theme: 'plain',
        styles: { font: 'times' },
        bodyStyles: {
            fontSize: 10,
            textColor: colors.text,
            font: 'times'
        },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 80 },
            1: { cellWidth: 'auto' }
        },
        margin: { left: margin + 5 }
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Budget Status
    doc.setFontSize(14);
    doc.setFont('times', 'bold');
    doc.text('Budget Status', margin, yPos);

    yPos += 10;

    const statusColor = remainingBudget >= 0 ? colors.success : colors.danger;
    const statusText = remainingBudget >= 0 ? 'Under Budget' : 'Over Budget';

    const budgetStatusData = [
        ['Status', statusText],
        ['Remaining', `Rs. ${Math.abs(remainingBudget).toLocaleString('en-IN')}`]
    ];

    doc.autoTable({
        startY: yPos,
        body: budgetStatusData,
        theme: 'plain',
        styles: { font: 'times' },
        bodyStyles: {
            fontSize: 10,
            textColor: colors.text,
            font: 'times'
        },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 80 },
            1: { cellWidth: 'auto' }
        },
        margin: { left: margin + 5 },
        didParseCell: function (data) {
            if (data.row.index === 0 && data.column.index === 1) {
                data.cell.styles.textColor = statusColor;
                data.cell.styles.fontStyle = 'bold';
            }
        }
    });

    yPos = doc.lastAutoTable.finalY + 20;

    // Category Breakdown
    doc.setTextColor(...colors.primary);
    doc.setFontSize(14);
    doc.setFont('times', 'bold');
    doc.text('EXPENSE BREAKDOWN BY CATEGORY', margin, yPos);

    yPos += 10;

    if (sortedCategories.length > 0) {
        const categoryTableData = sortedCategories.map(([category, data]) => {
            const percentage = income > 0 ? ((data.total / income) * 100).toFixed(1) : '0.0';
            return [
                category,
                `Rs. ${data.total.toLocaleString('en-IN')}`,
                `${percentage}%`
            ];
        });

        doc.autoTable({
            startY: yPos,
            head: [['Category', 'Amount', '% of Income']],
            body: categoryTableData,
            theme: 'striped',
            styles: { font: 'times' },
            headStyles: {
                fillColor: colors.primary,
                textColor: [255, 255, 255],
                fontSize: 11,
                fontStyle: 'bold',
                halign: 'left',
                font: 'times'
            },
            bodyStyles: {
                fontSize: 10,
                textColor: colors.text,
                font: 'times'
            },
            columnStyles: {
                0: { cellWidth: 60 },
                1: { halign: 'right', cellWidth: 50 },
                2: { halign: 'right', cellWidth: 'auto' }
            },
            margin: { left: margin, right: margin },
            alternateRowStyles: {
                fillColor: colors.bgLight
            }
        });
    } else {
        doc.setTextColor(...colors.textLight);
        doc.setFontSize(10);
        doc.setFont('times', 'italic');
        doc.text('No expenses recorded yet.', margin + 5, yPos);
    }

    addPageFooter(2);

    // ===== PAGE 3: SAVINGS & INSIGHTS =====
    doc.addPage();
    addPageHeader(3);
    yPos = 30;

    // Savings Progress
    doc.setTextColor(...colors.primary);
    doc.setFontSize(18);
    doc.setFont('times', 'bold');
    doc.text('SAVINGS PROGRESS', margin, yPos);

    yPos += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(margin, yPos, margin + 60, yPos);

    yPos += 15;

    const savingsData = [
        ['Current Savings', `Rs. ${totalSavings.toLocaleString('en-IN')}`],
        ['Savings Goal', `Rs. ${savingsGoal.toLocaleString('en-IN')}`],
        ['Progress', `${savingsProgress.toFixed(1)}%`]
    ];

    doc.autoTable({
        startY: yPos,
        body: savingsData,
        theme: 'plain',
        styles: { font: 'times' },
        bodyStyles: {
            fontSize: 10,
            textColor: colors.text,
            font: 'times'
        },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 80 },
            1: { cellWidth: 'auto' }
        },
        margin: { left: margin + 5 }
    });

    yPos = doc.lastAutoTable.finalY + 15;

    // Visual progress bar
    const barWidth = contentWidth - 10;
    const barHeight = 25;
    const progressWidth = (barWidth * savingsProgress) / 100;

    // Background
    doc.setFillColor(229, 231, 235);
    doc.roundedRect(margin + 5, yPos, barWidth, barHeight, 3, 3, 'F');

    // Progress
    if (progressWidth > 0) {
        const progressColor = savingsProgress >= 100 ? colors.success : colors.secondary;
        doc.setFillColor(...progressColor);
        doc.roundedRect(margin + 5, yPos, progressWidth, barHeight, 3, 3, 'F');
    }

    // Progress text
    doc.setFontSize(12);
    doc.setTextColor(255, 255, 255);
    doc.setFont('times', 'bold');
    if (progressWidth > 30) {
        doc.text(`${savingsProgress.toFixed(0)}%`, margin + 5 + progressWidth / 2, yPos + 16, { align: 'center' });
    }

    yPos += 40;

    // Financial Health Score
    doc.setTextColor(...colors.primary);
    doc.setFontSize(18);
    doc.setFont('times', 'bold');
    doc.text('FINANCIAL HEALTH SCORE', margin, yPos);

    yPos += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(margin, yPos, margin + 80, yPos);

    yPos += 20;

    // Calculate health score
    let healthScore = 0;
    const metrics = [];

    if (expenseRatio <= 50) {
        healthScore += 40;
        metrics.push('Excellent expense management');
    } else if (expenseRatio <= 70) {
        healthScore += 30;
        metrics.push('Good expense management');
    } else if (expenseRatio <= 90) {
        healthScore += 20;
        metrics.push('Moderate expense management');
    } else {
        healthScore += 10;
        metrics.push('High expense ratio');
    }

    if (savingsProgress >= 100) {
        healthScore += 30;
        metrics.push('Savings goal achieved');
    } else if (savingsProgress >= 75) {
        healthScore += 25;
        metrics.push('Good savings progress');
    } else if (savingsProgress >= 50) {
        healthScore += 20;
        metrics.push('Moderate savings progress');
    } else if (savingsProgress > 0) {
        healthScore += 10;
        metrics.push('Building savings');
    } else {
        metrics.push('No savings yet');
    }

    if (remainingBudget > income * 0.2) {
        healthScore += 30;
        metrics.push('Well under budget');
    } else if (remainingBudget > 0) {
        healthScore += 20;
        metrics.push('Under budget');
    } else if (remainingBudget >= -income * 0.1) {
        healthScore += 10;
        metrics.push('Slightly over budget');
    } else {
        metrics.push('Significantly over budget');
    }

    // Display score in a box
    doc.setFillColor(...colors.bgLight);
    doc.setDrawColor(...colors.border);
    doc.roundedRect(margin, yPos, contentWidth, 50, 3, 3, 'FD');

    let scoreColor = colors.success;
    if (healthScore < 50) scoreColor = colors.danger;
    else if (healthScore < 75) scoreColor = colors.warning;

    doc.setFontSize(48);
    doc.setFont('times', 'bold');
    doc.setTextColor(...scoreColor);
    doc.text(`${healthScore}/100`, pageWidth / 2, yPos + 25, { align: 'center' });

    doc.setFontSize(14);
    let rating = 'Excellent';
    if (healthScore < 50) rating = 'Needs Improvement';
    else if (healthScore < 75) rating = 'Good';
    doc.text(rating, pageWidth / 2, yPos + 40, { align: 'center' });

    yPos += 60;

    // Metrics list
    doc.setTextColor(...colors.text);
    doc.setFontSize(10);
    doc.setFont('times', 'normal');
    metrics.forEach((metric, index) => {
        doc.text(`\u2022 ${metric}`, margin + 5, yPos + (index * 7));
    });

    yPos += (metrics.length * 7) + 15;

    // Recommendations
    doc.setTextColor(...colors.primary);
    doc.setFontSize(18);
    doc.setFont('times', 'bold');
    doc.text('RECOMMENDATIONS', margin, yPos);

    yPos += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(margin, yPos, margin + 65, yPos);

    yPos += 15;

    const recommendations = [];

    if (expenseRatio > 80) {
        recommendations.push('Consider reducing expenses to maintain a healthier budget');
    }

    if (sortedCategories.length > 0) {
        const topCategory = sortedCategories[0];
        const topCategoryPercent = income > 0 ? ((topCategory[1].total / income) * 100).toFixed(0) : 0;
        if (topCategoryPercent > 30) {
            recommendations.push(`${topCategory[0]} spending is ${topCategoryPercent}% of income - consider reviewing this category`);
        }
    }

    if (savingsProgress < 50 && savingsGoal > 0) {
        recommendations.push('Increase monthly savings to reach your goal faster');
    }

    if (remainingBudget < 0) {
        recommendations.push('You are over budget - review and cut unnecessary expenses');
    } else if (remainingBudget > income * 0.3) {
        recommendations.push('Great job! Consider increasing your savings goal');
    }

    if (manualExpenses.length < 5) {
        recommendations.push('Track more expenses for better financial insights');
    }

    if (recommendations.length === 0) {
        recommendations.push('Keep up the great work with your financial management!');
        recommendations.push('Continue tracking expenses regularly');
        recommendations.push('Review your budget monthly for optimization');
    }

    doc.setTextColor(...colors.text);
    doc.setFontSize(10);
    doc.setFont('times', 'normal');

    recommendations.forEach((rec, index) => {
        const lines = doc.splitTextToSize(`\u2022 ${rec}`, contentWidth - 10);
        lines.forEach(line => {
            if (yPos > pageHeight - 30) {
                // Don't add footer yet, we'll add it after all content
                doc.addPage();
                addPageHeader(4);
                yPos = 30;
            }
            doc.text(line, margin + 5, yPos);
            yPos += 6;
        });
        yPos += 3;
    });

    // Add footer to page 3 only if we're still on page 3
    const currentPage = doc.internal.getCurrentPageInfo().pageNumber;
    if (currentPage === 3) {
        addPageFooter(3);
    }

    // ===== PAGE 4: CONCLUSION =====
    // Always add page 4 with conclusion
    if (currentPage === 3) {
        doc.addPage();
        addPageHeader(4);
        yPos = 30;
    } else {
        // We're already on page 4, just continue
        yPos += 15;
    }

    // Conclusion Section
    doc.setTextColor(...colors.primary);
    doc.setFontSize(18);
    doc.setFont('times', 'bold');
    doc.text('CONCLUSION', margin, yPos);

    yPos += 3;
    doc.setDrawColor(...colors.primary);
    doc.setLineWidth(1);
    doc.line(margin, yPos, margin + 45, yPos);

    yPos += 15;

    doc.setTextColor(...colors.text);
    doc.setFontSize(11);
    doc.setFont('times', 'normal');

    // Generate conclusion based on financial health
    const conclusionParagraphs = [];

    // Opening statement
    if (healthScore >= 75) {
        conclusionParagraphs.push(`This financial report demonstrates strong financial management with a health score of ${healthScore}/100. Your current financial practices are commendable and position you well for achieving your financial goals.`);
    } else if (healthScore >= 50) {
        conclusionParagraphs.push(`This financial report shows good financial management with a health score of ${healthScore}/100. There are opportunities for improvement that, when addressed, will strengthen your financial position.`);
    } else {
        conclusionParagraphs.push(`This financial report indicates areas requiring attention, with a health score of ${healthScore}/100. Implementing the recommendations provided will significantly improve your financial health.`);
    }

    // Budget status conclusion
    if (remainingBudget >= 0) {
        const savingsRate = income > 0 ? ((remainingBudget / income) * 100).toFixed(1) : 0;
        conclusionParagraphs.push(`You are currently under budget with Rs. ${remainingBudget.toLocaleString('en-IN')} remaining, representing ${savingsRate}% of your income. This surplus provides an excellent opportunity to accelerate your savings goals or build an emergency fund.`);
    } else {
        conclusionParagraphs.push(`Your current expenses exceed your income by Rs. ${Math.abs(remainingBudget).toLocaleString('en-IN')}. Addressing this deficit should be your immediate priority to avoid financial stress and debt accumulation.`);
    }

    // Savings conclusion
    if (savingsGoal > 0) {
        if (savingsProgress >= 100) {
            conclusionParagraphs.push(`Congratulations on achieving your savings goal of Rs. ${savingsGoal.toLocaleString('en-IN')}! Consider setting a new, more ambitious goal to continue building your financial security.`);
        } else if (savingsProgress >= 50) {
            const remaining = savingsGoal - totalSavings;
            conclusionParagraphs.push(`You have made significant progress toward your savings goal, with ${savingsProgress.toFixed(1)}% completed. Maintaining your current pace will help you reach the remaining Rs. ${remaining.toLocaleString('en-IN')} target.`);
        } else if (savingsProgress > 0) {
            conclusionParagraphs.push(`Your savings journey has begun with ${savingsProgress.toFixed(1)}% of your goal achieved. Consistent contributions, even small ones, will compound over time to help you reach your target.`);
        } else {
            conclusionParagraphs.push(`Starting your savings journey is crucial for financial security. Consider automating small, regular contributions to build momentum toward your goal of Rs. ${savingsGoal.toLocaleString('en-IN')}.`);
        }
    }

    // Closing statement
    conclusionParagraphs.push(`Regular monitoring of your finances through reports like this enables informed decision-making and helps maintain financial discipline. We recommend reviewing your budget monthly and adjusting your strategies as your circumstances evolve.`);

    conclusionParagraphs.push(`Thank you for using FinancePro. We are committed to supporting your journey toward financial wellness and prosperity.`);

    // Render conclusion paragraphs
    conclusionParagraphs.forEach((paragraph, index) => {
        const lines = doc.splitTextToSize(paragraph, contentWidth - 10);
        lines.forEach(line => {
            if (yPos > pageHeight - 30) {
                doc.addPage();
                addPageHeader(5);
                yPos = 30;
            }
            doc.text(line, margin + 5, yPos);
            yPos += 6;
        });
        yPos += 8; // Extra space between paragraphs
    });

    // Signature section
    yPos += 10;
    if (yPos > pageHeight - 60) {
        doc.addPage();
        addPageHeader(5);
        yPos = 30;
    }

    doc.setDrawColor(...colors.border);
    doc.line(margin + 5, yPos, margin + 70, yPos);
    yPos += 8;
    doc.setFontSize(10);
    doc.setFont('times', 'italic');
    doc.text('FinancePro Financial Advisory', margin + 5, yPos);
    yPos += 6;
    doc.text(`Generated on ${reportDate}`, margin + 5, yPos);

    // Add footer to final page
    const finalPage = doc.internal.getCurrentPageInfo().pageNumber;
    addPageFooter(finalPage);

    return doc;
}
